name: Auto Convert Rules

# è§¦å‘æœºåˆ¶ï¼šæ¯å¤© UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00) æˆ– æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # èµ‹äºˆå†™æƒé™ï¼Œæ— éœ€ Token

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Dependencies
        # ç›´æ¥åœ¨è¿™é‡Œå®‰è£…ï¼Œä¸éœ€è¦ requirements.txt
        run: pip install PyYAML requests

      - name: ğŸ“¡ Download Upstream Rules
        # ä½¿ç”¨ depth=1 æµ…å…‹éš†ï¼Œé€Ÿåº¦å¿«ä¸”æ—  API é™åˆ¶
        run: git clone --depth 1 https://github.com/blackmatrix7/ios_rule_script.git temp_source

      - name: ğŸ› ï¸ Setup Mihomo Kernel
        # è‡ªåŠ¨ä¸‹è½½æœ€æ–° Alpha ç‰ˆå†…æ ¸
        run: |
          TAG=$(curl -sL https://api.github.com/repos/MetaCubeX/mihomo/releases | jq -r 'map(select(.prerelease)) | first | .tag_name')
          echo "Fetching Mihomo $TAG..."
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/$TAG/mihomo-linux-amd64-$TAG.gz
          gunzip mihomo-linux-amd64-$TAG.gz
          mv mihomo-linux-amd64-$TAG mihomo
          chmod +x mihomo

      - name: ğŸš€ Run Converter
        run: python scripts/builder.py

      - name: ğŸ§¹ Cleanup & Commit
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf temp_source mihomo
          
          # é…ç½® Git èº«ä»½ (ä½¿ç”¨ GitHub Actions Bot)
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ ç”Ÿæˆçš„è§„åˆ™ç›®å½•
          git add rule/Mihomo/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼Œæœ‰åˆ™æäº¤
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update rules [$(date +'%Y-%m-%d')]"
            git push
          fi
