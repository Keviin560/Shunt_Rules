name: Auto Convert Rules

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Dependencies
        run: pip install PyYAML requests

      - name: ğŸ“¡ Download Upstream Rules
        run: git clone --depth 1 https://github.com/blackmatrix7/ios_rule_script.git temp_source

      - name: ğŸ› ï¸ Setup Mihomo Kernel
        run: |
          # 1. è·å– Prerelease çš„ API æ•°æ®
          API_URL="https://api.github.com/repos/MetaCubeX/mihomo/releases"
          
          # 2. ä½¿ç”¨ jq è¿‡æ»¤å‡ºç¬¬ä¸€ä¸ª Prerelease ç‰ˆæœ¬ä¸­ï¼ŒåŒ…å« 'linux-amd64' ä¸”ä»¥ '.gz' ç»“å°¾çš„æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥
          # æ’é™¤ compatible ç‰ˆæœ¬ï¼Œåªå–æ ‡å‡†ç‰ˆ
          DOWNLOAD_URL=$(curl -sL $API_URL | jq -r 'map(select(.prerelease)) | first | .assets[] | select(.name | contains("linux-amd64") and endswith(".gz") and (contains("compatible") | not)) | .browser_download_url' | head -n 1)
          
          echo "Found Kernel URL: $DOWNLOAD_URL"
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ Error: Could not find a valid download URL!"
            exit 1
          fi
          
          # 3. ä¸‹è½½å¹¶è§£å‹
          wget -q -O mihomo.gz "$DOWNLOAD_URL"
          gunzip mihomo.gz
          mv mihomo mihomo-bin
          chmod +x mihomo-bin
          
          # 4. éªŒè¯
          ./mihomo-bin -v
          
          # 5. é‡å‘½åä¸º Python è„šæœ¬é¢„æœŸçš„åå­—
          mv mihomo-bin mihomo

      - name: ğŸš€ Run Converter
        run: python scripts/builder.py

      - name: ğŸ§¹ Cleanup & Commit
        run: |
          rm -rf temp_source mihomo
          
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add rule/Mihomo/
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update rules [$(date +'%Y-%m-%d')]"
            git push
          fi
