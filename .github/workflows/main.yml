name: Auto Convert Rules

on:
  schedule:
    # æ ¸å¿ƒä¿®æ­£ï¼šåŒ—äº¬æ—¶é—´ 04:00 = UTC 20:00
    - cron: '0 20 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è®¾ç½®ä¸º 0 ä»¥æ‹‰å–æ‰€æœ‰å†å²ï¼Œç¡®ä¿ history.json çš„æ›´æ–°èƒ½è¢« Git æ­£ç¡®è¯†åˆ«
          fetch-depth: 0

      - name: ğŸ é…ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install PyYAML requests

      - name: ğŸ“¡ å…‹éš†è§„åˆ™æº
        # æµ…å…‹éš†ä¸Šæ¸¸ä»“åº“ä»¥èŠ‚çœæ—¶é—´
        run: git clone --depth 1 https://github.com/blackmatrix7/ios_rule_script.git temp_source

      - name: ğŸ› ï¸ éƒ¨ç½²å†…æ ¸
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_URL="https://api.github.com/repos/MetaCubeX/mihomo/releases"
          # åªå– Latest Stable (é prerelease)
          DOWNLOAD_URL=$(curl -sL -H "Authorization: token $GH_TOKEN" $API_URL | jq -r 'map(select(.prerelease==false)) | first | .assets[] | select(.name | contains("linux-amd64") and endswith(".gz") and (contains("compatible") | not)) | .browser_download_url' | head -n 1)
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "âŒ Error: Could not find a valid Stable download URL!"
            exit 1
          fi
          
          wget -q -O mihomo.gz "$DOWNLOAD_URL"
          gunzip mihomo.gz
          mv mihomo mihomo-bin
          chmod +x mihomo-bin
          ./mihomo-bin -v
          mv mihomo-bin mihomo

      - name: ğŸš€ æ‰§è¡Œè½¬æ¢ä¸æ›´æ–° README é¡µ
        run: python scripts/builder.py
        env:
          # å…³é”®ï¼šä¼ é€’ç¯å¢ƒå˜é‡ï¼Œè®©è„šæœ¬æ™ºèƒ½è¯†åˆ« Author å’Œ Repo URL
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: ğŸ§¹ æäº¤äº§ç‰©
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf temp_source mihomo
          
          # é…ç½® Git èº«ä»½
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰äº§ç‰©ç”Ÿæˆ
          if [ ! -d "rule/Mihomo" ] || [ -z "$(ls -A rule/Mihomo)" ]; then
             echo "âš ï¸ No rules generated, skipping git ops."
             exit 0
          fi
          
          # âœ… å…³é”®ç‚¹ï¼šæ·»åŠ æ‰€æœ‰ç›®å½•å’Œå¿…è¦çš„çŠ¶æ€æ–‡ä»¶
          git add rule/Mihomo/ rule/Loon/ history.json README.md
          
          # æäº¤å¹¶æ¨é€
          if git diff --staged --quiet; then
            echo "zk: No changes detected in rules or dashboard."
          else
            git commit -m "chore: auto-sync rules & dashboard [$(date +'%Y-%m-%d %H:%M')]"
            git push
          fi
