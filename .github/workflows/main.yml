name: Auto Convert Rules (Self-Healing)

on:
  schedule:
    - cron: '0 2 * * *' # UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # èµ‹äºˆæäº¤ä»£ç çš„æƒé™

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–å·¥å…·
        # jq ç”¨äºè§£æ JSONï¼ŒPyYAML ç”¨äºå¤„ç†è§„åˆ™
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install PyYAML requests

      - name: ğŸ“¡ å…‹éš†ä¸Šæ¸¸è§„åˆ™åº“
        # ä½¿ç”¨ depth=1 æµ…å…‹éš†ï¼Œé¿å…ä¸‹è½½å†å²è®°å½•ï¼Œæå¤§æå‡é€Ÿåº¦
        run: git clone --depth 1 https://github.com/blackmatrix7/ios_rule_script.git temp_source

      - name: ğŸ› ï¸ éƒ¨ç½² Mihomo å†…æ ¸ (æ™ºèƒ½é”å®š Latest Stable)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” æ­£åœ¨å¯»æ‰¾æœ€æ–°çš„ Mihomo æ­£å¼å‘è¡Œç‰ˆ (Latest Stable)..."
          
          # 1. è·å–æ‰€æœ‰ Release æ•°æ® (å¸¦ Token é¿å…é™æµ)
          API_URL="https://api.github.com/repos/MetaCubeX/mihomo/releases"
          
          # 2. æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ï¼š
          # select(.prerelease==false) -> æ’é™¤ Alpha/Beta
          # select(.name | contains("linux-amd64")) -> é”å®šæ¶æ„
          # select(.name | endswith(".gz")) -> é”å®šå‹ç¼©åŒ…
          # select(.name | contains("compatible") | not) -> æ’é™¤å…¼å®¹æ¨¡å¼åŒ…
          
          DOWNLOAD_URL=$(curl -sL -H "Authorization: token $GH_TOKEN" $API_URL | jq -r 'map(select(.prerelease==false)) | first | .assets[] | select(.name | contains("linux-amd64") and endswith(".gz") and (contains("compatible") | not)) | .browser_download_url' | head -n 1)
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Latest Stable ç‰ˆæœ¬ï¼å¯èƒ½å®˜æ–¹åªæœ‰ Prereleaseã€‚"
            echo "âš ï¸ å»ºè®®æ£€æŸ¥: https://github.com/MetaCubeX/mihomo/releases"
            exit 1
          fi
          
          echo "âœ… é”å®šå†…æ ¸: $DOWNLOAD_URL"
          
          # 3. ä¸‹è½½å¹¶éƒ¨ç½²
          wget -q -O mihomo.gz "$DOWNLOAD_URL"
          gunzip mihomo.gz
          mv mihomo mihomo-bin
          chmod +x mihomo-bin
          
          # 4. éªŒè¯å¹¶é‡å‘½å
          ./mihomo-bin -v
          mv mihomo-bin mihomo

      - name: ğŸš€ æ‰§è¡Œæ„å»ºå¼•æ“ (Python)
        run: python scripts/builder.py

      - name: ğŸ§¹ æ¸…ç†ä¸æäº¤
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œé˜²æ­¢æ±¡æŸ“ä»“åº“
          rm -rf temp_source mihomo
          
          # é…ç½® Git èº«ä»½
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ äº§ç‰©
          git add rule/Mihomo/
          
          # ä»…å½“æœ‰å˜åŠ¨æ—¶æäº¤
          if git diff --staged --quiet; then
            echo "zk: æ£€æµ‹åˆ°æ— è§„åˆ™å˜æ›´ï¼Œæœ¬æ¬¡è·³è¿‡æäº¤ã€‚"
          else
            git commit -m "chore(rule): sync upstream & auto-fix [$(date +'%Y-%m-%d')]"
            git push
          fi
